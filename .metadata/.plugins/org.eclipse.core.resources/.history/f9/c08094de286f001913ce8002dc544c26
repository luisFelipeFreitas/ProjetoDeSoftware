package dao.impl;

import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.LockModeType;
import javax.persistence.NoResultException;

import dao.RotaDAO;
import excecao.InfraestruturaException;
import excecao.ObjetoNaoEncontradoException;
import modelo.Personagem;
import util.JPAUtil;

public class RotaDAOImpl implements RotaDAO {
    public long inclui(Personagem umaRota) {
	try {
	    EntityManager em = JPAUtil.getEntityManager();

	    em.persist(umaRota);

	    return umaRota.getId();
	} catch (RuntimeException e) {
	    throw new InfraestruturaException(e);
	}
    }
    
    public void altera(Personagem umaRota) throws ObjetoNaoEncontradoException {
	try {
	    EntityManager em = JPAUtil.getEntityManager();

	    Personagem Frota = em.find(Personagem.class, umaRota.getId(), LockModeType.PESSIMISTIC_WRITE);

	    if (Frota == null) {
		throw new ObjetoNaoEncontradoException();
	    }

	    em.merge(umaRota);
	} catch (RuntimeException e) {
	    throw new InfraestruturaException(e);
	}
    }

    public void exclui(long id) throws ObjetoNaoEncontradoException {
	try {
	    EntityManager em = JPAUtil.getEntityManager();

	    Personagem personagem = em.find(Personagem.class, id, LockModeType.PESSIMISTIC_WRITE);

	    if (personagem == null) {
		throw new ObjetoNaoEncontradoException();
	    }

	    em.remove(personagem);
	} catch (RuntimeException e) {
	    throw new InfraestruturaException(e);
	}
    }

    public Personagem recuperaUmaRota(long id) throws ObjetoNaoEncontradoException {
	try {
	    EntityManager em = JPAUtil.getEntityManager();

	    Personagem umaRota = (Personagem) em.find(Personagem.class, new Long(id));

	    if (umaRota == null) {
		throw new ObjetoNaoEncontradoException();
	    }

	    return umaRota;
	} catch (RuntimeException e) {
	    throw new InfraestruturaException(e);
	}
    }
    
    public Personagem recuperaUmaRotaComLock(long id) throws ObjetoNaoEncontradoException {
    	try {
    	    EntityManager em = JPAUtil.getEntityManager();

    	    Personagem umaRota = em.find(Personagem.class, id, LockModeType.PESSIMISTIC_WRITE);

    	    if (umaRota == null) {
    		throw new ObjetoNaoEncontradoException();
    	    }

    	    return umaRota;
    	} catch (RuntimeException e) {
    	    throw new InfraestruturaException(e);
    	}
        }
    
    public Personagem recuperaUmaRotaEParadas(long numero) throws ObjetoNaoEncontradoException {
    	try {
    	    EntityManager em = JPAUtil.getEntityManager();

    	    String busca = "select r from rota r left outer join fetch r.paradas where r.id = :id";

    	    Personagem umaFrota = (Personagem) em.createQuery(busca).setParameter("id", numero).getSingleResult();

    	    return umaFrota;
    	} catch (NoResultException e) {
    	    throw new ObjetoNaoEncontradoException();
    	}
        }
    
    @SuppressWarnings("unchecked")
    public List<Personagem> recuperaRotasEParadas() {

	EntityManager em = JPAUtil.getEntityManager();

	List<Personagem> Personagems = em
		.createQuery("select distinct r from frota r left outer join fetch r.paradas")
		.getResultList();

	return Personagems;
    }
	
    

    @SuppressWarnings("unchecked")
    public List<Personagem> recuperaRotas() {
	EntityManager em = JPAUtil.getEntityManager();

	return em.createQuery("select r from Rota r order by r.id").getResultList();
    }


}
